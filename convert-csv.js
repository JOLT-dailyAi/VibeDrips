const csv=require('csv-parser'),fs=require('fs'),path=require('path'),validationConfig=require('./validation-config.js'),dataDir=path.join(__dirname,'data');
const CURRENCY_MAP={'INR':{symbol:'‚Çπ',countries:['India'],name:'Indian Rupee'},'USD':{symbol:'$',countries:['United States'],name:'US Dollar'},'EUR':{symbol:'‚Ç¨',countries:['Germany','France','Italy','Spain','Netherlands','Belgium','Ireland'],name:'Euro'},'GBP':{symbol:'¬£',countries:['United Kingdom'],name:'British Pound'},'JPY':{symbol:'¬•',countries:['Japan'],name:'Japanese Yen'},'CAD':{symbol:'C$',countries:['Canada'],name:'Canadian Dollar'},'AUD':{symbol:'A$',countries:['Australia'],name:'Australian Dollar'},'BRL':{symbol:'R$',countries:['Brazil'],name:'Brazilian Real'},'MXN':{symbol:'$',countries:['Mexico'],name:'Mexican Peso'},'AED':{symbol:'ÿØ.ÿ•',countries:['United Arab Emirates'],name:'UAE Dirham'},'SGD':{symbol:'S$',countries:['Singapore'],name:'Singapore Dollar'},'SAR':{symbol:'Ô∑º',countries:['Saudi Arabia'],name:'Saudi Riyal'},'SEK':{symbol:'kr',countries:['Sweden'],name:'Swedish Krona'},'PLN':{symbol:'z≈Ç',countries:['Poland'],name:'Polish Zloty'}};
const CURRENCY_PATTERNS={'‚Çπ':'INR','$':'USD','‚Ç¨':'EUR','¬£':'GBP','¬•':'JPY','C$':'CAD','A$':'AUD','R$':'BRL','ÿØ.ÿ•':'AED','S$':'SGD','Ô∑º':'SAR','kr':'SEK','z≈Ç':'PLN'};
const FIELD_CONFIG={METADATA_PATTERNS:['Influencer','influencer','ManualCollections','manual_collections','SeasonOverride','season_override','Product Source Link','source_link','Amazon SiteStripe (Short)','amazon_short','Amazon SiteStripe (Long)','amazon_long','Reference Media for similar products','reference_media','referenceMedia','Error-Flag','Error-Reason','Error-Fields','regional_availability','regional_variants','featured','trending',/^asin$/i,/affiliate.*link/i,/sitestripe/i,/_id$/i,/^id$/i],CORE_FIELDS:['productTitle','Title','name','brand','Currency','symbol','currency','price','originalPrice','discountPercentage','display_price','original_price','discount_percentage','availability','MainImage','AllImages','all_images','main_image','customerRating','Rating','customer_rating','reviewCount','ReviewCount','review_count','Description','description','Category','categoryHierarchy','category','subcategory','itemTypeName','productType','product_type'],PRODUCT_DETAILS_KEYWORDS:{weight:{label:'Weight',priority:1,patterns:[/weight/i]},dimensions:{label:'Dimensions',priority:1,patterns:[/dimension/i,/size/i]},color:{label:'Color',priority:1,patterns:[/colou?r/i]},material:{label:'Material',priority:1,patterns:[/material/i,/fabric/i]},origin:{label:'Made in',priority:2,patterns:[/country.*origin/i,/made.*in/i,/origin/i]}},ADDITIONAL_INFO_CATEGORIES:{'Manufacturing':{patterns:[/manufacturer/i,/packer/i,/importer/i,/imported.*by/i]},'Technical':{patterns:[/model/i,/voltage/i,/wattage/i,/battery/i,/connectivity/i,/noise/i,/power/i,/frequency/i,/charging/i,/capacity/i]},'Books':{patterns:[/isbn/i,/publisher/i,/reading.*age/i,/hardcover/i,/paperback/i,/pages/i,/language/i,/edition/i,/author/i]},'Product Specs':{patterns:[/theme/i,/character/i,/pieces/i,/count/i,/age/i,/component/i,/feature/i,/pattern/i,/finish/i,/style/i,/occasion/i]},'Care Instructions':{patterns:[/care/i,/wash/i,/clean/i,/maintenance/i,/instruction/i]}},FIELD_ALIASES:{weight:['weight','itemweight','productweight','netweight'],dimensions:['dimensions','productdimensions','itemdimensionslxwxh','size'],color:['color','colour','colorname','itemcolor'],origin:['countryoforigin','madein','origin'],model:['modelname','itemmodelnumber','modelnumber','model']}};
const SEASONS_CONFIG={VALID_OPTIONS:['','Winter','Summer','Monsoon','Autumn','None'],PATTERNS:{Winter:/winter|cold|snow|warm|jacket|sweater|hoodie|thermal/i,Summer:/summer|cool|hot|heat|light|breathable|shorts|tank/i,Monsoon:/monsoon|rain|waterproof|umbrella|raincoat/i,Autumn:/autumn|fall/i}};
const DROPS_CONFIG={THRESHOLDS:{HIGH_VISIBILITY_MEDIA_COUNT:2,MULTI_REGION_THRESHOLD:2,NEW_RELEASE_DAYS:60,ARCHIVE_THRESHOLD_DAYS:60,INFLUENCER_KEYWORDS:['instagram.com/reel','youtube.com/shorts','tiktok.com','@','influencer']},CATEGORIES:{'creator-picks':{label:'Creator Picks',emoji:'üé¨',subtitle:'Featured by content creators',priority:1},'global-drops':{label:'Global Drops',emoji:'üåç',subtitle:'Available across regions',priority:2},'viral-reels':{label:'Viral Reels',emoji:'üì±',subtitle:'Trending on social platforms',priority:3},'new-releases':{label:'New Releases',emoji:'üÜï',subtitle:'Recently launched products',priority:4}}};
function isMetadataField(e){return FIELD_CONFIG.METADATA_PATTERNS.some(t=>t instanceof RegExp?t.test(e):e===t||e.toLowerCase()===t.toLowerCase())}
function isCoreField(e){return FIELD_CONFIG.CORE_FIELDS.some(t=>e===t||e.toLowerCase()===t.toLowerCase())}
function isEmptyValue(e){if(null===e||void 0===e)return!0;if('string'==typeof e){const t=e.trim().toLowerCase();return['','not specified','n/a','na','null','undefined','none','-','--'].includes(t)}return'number'==typeof e&&0===e}
function resolveFieldAlias(e){const t=e.toLowerCase().replace(/[_\s-]/g,'');for(const[e,r]of Object.entries(FIELD_CONFIG.FIELD_ALIASES))if(r.some(e=>t.includes(e.toLowerCase().replace(/[_\s-]/g,''))))return e;return e}
function normalizeValueForComparison(e){return'string'!=typeof e?String(e).toLowerCase().trim():e.toLowerCase().trim().replace(/\s+/g,' ').replace(/[,]/g,'').replace(/(\d+\.?\d*)\s*(kg|g|lb|oz|cm|mm|inch|in)/gi,(e,t,r)=>{const n=parseFloat(t),i=r.toLowerCase();return['kg','kilogram'].includes(i)?n*1e3+'g':['lb','pound'].includes(i)?n*453.592+'g':['oz','ounce'].includes(i)?n*28.3495+'g':['mm','millimeter'].includes(i)?n/10+'cm':['inch','in'].includes(i)?n*2.54+'cm':n+i})}
function isValueInCoreFields(e,t){if(!e||isEmptyValue(e))return!1;const r=normalizeValueForComparison(e),n=normalizeValueForComparison(t.name||''),i=normalizeValueForComparison(t.description||'');return r.length>3&&(n.includes(r)||i.includes(r))}
function detectProductDetail(e,t){if(isEmptyValue(t))return null;const r=resolveFieldAlias(e);for(const[n,i]of Object.entries(FIELD_CONFIG.PRODUCT_DETAILS_KEYWORDS))if(r===n||i.patterns.some(t=>t.test(e)))return{key:r,label:i.label,value:t,priority:i.priority};return null}
function detectAdditionalInfoCategory(e){for(const[t,r]of Object.entries(FIELD_CONFIG.ADDITIONAL_INFO_CATEGORIES))if(r.patterns.some(t=>t.test(e)))return{category:t};return{category:'Other'}}
function humanizeFieldName(e){return e.replace(/([A-Z])/g,' $1').replace(/_/g,' ').replace(/-/g,' ').replace(/\s+/g,' ').replace(/\b\w/g,e=>e.toUpperCase()).trim()}
function getProductReleaseDate(e){if(e.date_first_available&&e.date_first_available.trim())try{const t=new Date(e.date_first_available);if(!isNaN(t.getTime()))return t}catch(t){console.warn(`‚ö†Ô∏è Invalid date_first_available: ${e.date_first_available}`)}if(e.publication_date&&e.publication_date.trim())try{const t=new Date(e.publication_date);if(!isNaN(t.getTime()))return t}catch(t){console.warn(`‚ö†Ô∏è Invalid publication_date: ${e.publication_date}`)}if(e.manufacture_year&&e.manufacture_year.trim()){const t=parseInt(e.manufacture_year);if(t>=2e3&&t<=2030)return new Date(`${t}-01-01`)}for(const[t,r]of Object.entries(e))if(t.toLowerCase().includes('year')&&r&&r.trim()){const e=parseInt(r);if(e>=2e3&&e<=2030)return new Date(`${e}-01-01`)}return null}
function detectSeasonFromText(e,t){if(t&&''!==t.trim()){const e=t.trim();if('None'===e)return null;if(SEASONS_CONFIG.VALID_OPTIONS.includes(e))return e;console.warn(`‚ö†Ô∏è Invalid SeasonOverride: "${e}". Using auto-detect.`)}if(!e)return null;const r=e.toLowerCase();for(const[e,t]of Object.entries(SEASONS_CONFIG.PATTERNS))if(t.test(r))return e;return null}
function extractInfluencerAndCollections(e){const t=e.Influencer?.trim()||null,r=[];return e.ManualCollections&&e.ManualCollections.trim()&&r.push(...e.ManualCollections.split(/[|,]/).map(e=>e.trim()).filter(Boolean)),{influencer:t,manualCollections:r,seasonOverride:e.SeasonOverride?.trim()||''}}
function structureProductData(e,t){const r=[],n=[],i=new Set,o=new Map,a=[];Object.keys(e).forEach(s=>{const c=e[s];if(isMetadataField(s)||isCoreField(s)||isEmptyValue(c))return;const l=resolveFieldAlias(s),u=normalizeValueForComparison(c);if(isValueInCoreFields(c,t))return a.push(s),void console.warn(`‚ö†Ô∏è Redundant field "${s}": value already in title/description`);if(['http','www','amazon','asin'].some(e=>u.includes(e)))return a.push(s),void console.warn(`‚ö†Ô∏è Metadata leaked into field "${s}": ${c}`);const d=detectProductDetail(s,c);if(d){const e=l.toLowerCase();if(o.has(e)){const t=o.get(e);if(normalizeValueForComparison(t.value)!==u)return a.push(s),console.warn(`‚ö†Ô∏è CONFLICT in ${l}:`),console.warn(`  ${t.source}: "${t.value}"`),console.warn(`  ${s}: "${c}"`),void console.warn('  ‚Üí Keeping first value')}else{const e=d.label.toLowerCase();i.has(e)||(r.push(d),i.add(e),o.set(l.toLowerCase(),{value:c,source:s}))}return}const{category:p}=detectAdditionalInfoCategory(s),f=humanizeFieldName(s),g=f.toLowerCase(),m=l.toLowerCase();if(o.has(m)){const e=o.get(m);if(normalizeValueForComparison(e.value)!==u)return a.push(s),console.warn(`‚ö†Ô∏è CONFLICT in ${l}:`),console.warn(`  ${e.source}: "${e.value}"`),void console.warn(`  ${s}: "${c}`)}else i.has(g)||(n.push({key:s,label:f,category:p,value:c}),i.add(g),o.set(m,{value:c,source:s}))});r.sort((e,t)=>e.priority-t.priority);const s={};n.forEach(e=>{s[e.category]||(s[e.category]=[]),s[e.category].push(e)});const c={...t,productDetails:r,additionalInfo:s},l=[...new Set([...t['Error-Fields']||[],...a])];return l.length>0&&(c['Error-Flag']=1,c['Error-Fields']=l),c}
function detectInfluencerPresence(e,t,r){return!!(e.Influencer&&''!==e.Influencer.trim())||[t,...r||[]].filter(Boolean).some(e=>DROPS_CONFIG.THRESHOLDS.INFLUENCER_KEYWORDS.some(t=>e.toLowerCase().includes(t.toLowerCase())))}
function computeDropCategories(e){const t=[];return(e.is_social_proof||e.is_high_visibility)&&t.push('creator-picks'),e.is_global&&t.push('global-drops'),e.is_high_visibility&&e.is_social_proof&&t.push('viral-reels'),e.is_new_release&&t.push('new-releases'),t}
function computeDropSignals(e,t,r,n){const i=e.sourceLink||e['Product Source Link']||'',o=t&&t.length>1,a=t?t.length:i?1:0,s=r?Object.keys(r):[],c=s.length>0,l=detectInfluencerPresence(e,i,t),u=c&&s.length>=DROPS_CONFIG.THRESHOLDS.MULTI_REGION_THRESHOLD,d=a>=DROPS_CONFIG.THRESHOLDS.HIGH_VISIBILITY_MEDIA_COUNT,p=l;let f=!1,g=null;if(n)try{const e=new Date(n),t=new Date;g=Math.floor((t-e)/864e5),f=g<=DROPS_CONFIG.THRESHOLDS.NEW_RELEASE_DAYS}catch(e){console.warn(`‚ö†Ô∏è Invalid release_date for drop signals: ${n}`)}return{has_reference_media:o,media_count:a,regional_availability:c,available_regions:s,influencer_presence:l,is_global:u,is_high_visibility:d,is_social_proof:p,is_new_release:f,product_age_days:g,drop_categories:computeDropCategories({is_global:u,is_high_visibility:d,is_social_proof:p,is_new_release:f,influencer_presence:l})}}
function generateInfluencersJSON(e){const t={};return e.forEach(e=>{if(!e.influencer)return;t[e.influencer]||(t[e.influencer]={name:e.influencer,productCount:0,totalValue:0,categories:new Set,brands:new Set,currencies:new Set,products:[]});const r=t[e.influencer];r.productCount++,r.totalValue+=e.price||0,e.category&&r.categories.add(e.category),e.brand&&r.brands.add(e.brand),e.currency&&r.currencies.add(e.currency),r.products.push({asin:e.asin,currency:e.currency,drop_categories:e.drop_signals?.drop_categories||[]})}),Object.values(t).forEach(e=>{e.categories=Array.from(e.categories),e.brands=Array.from(e.brands),e.currencies=Array.from(e.currencies)}),t}
function generateCollectionsJSON(e){const t={};return e.forEach(e=>{e.manual_collections&&0!==e.manual_collections.length&&e.manual_collections.forEach(r=>{t[r]||(t[r]={name:r,productCount:0,totalValue:0,categories:new Set,brands:new Set,currencies:new Set,influencers:new Set,priceRange:{min:1/0,max:0},products:[]});const n=t[r];n.productCount++,n.totalValue+=e.price||0,e.category&&n.categories.add(e.category),e.brand&&n.brands.add(e.brand),e.currency&&n.currencies.add(e.currency),e.influencer&&n.influencers.add(e.influencer),e.price&&(n.priceRange.min=Math.min(n.priceRange.min,e.price),n.priceRange.max=Math.max(n.priceRange.max,e.price)),n.products.push({asin:e.asin,currency:e.currency,drop_categories:e.drop_signals?.drop_categories||[],influencer:e.influencer})})}),Object.values(t).forEach(e=>{e.categories=Array.from(e.categories),e.brands=Array.from(e.brands),e.currencies=Array.from(e.currencies),e.influencers=Array.from(e.influencers),e.priceRange.min===1/0&&(e.priceRange.min=0)}),t}
function generateDropsJSON(e){const t={categories:DROPS_CONFIG.CATEGORIES,last_updated:(new Date).toISOString()},r={};return Object.keys(DROPS_CONFIG.CATEGORIES).forEach(e=>{r[e]={...DROPS_CONFIG.CATEGORIES[e],productCount:0,products:[]}}),e.forEach(e=>{(e.drop_signals?.drop_categories||[]).forEach(t=>{r[t]&&(r[t].productCount++,r[t].products.push({asin:e.asin,currency:e.currency,influencer:e.influencer,release_date:e.release_date}))})}),Object.values(r).forEach(e=>{e.products.sort((e,t)=>{const r=e.release_date?new Date(e.release_date):new Date(0),n=t.release_date?new Date(t.release_date):new Date(0);return n-r})}),t.drops_by_category=r,t}
function generateErrorsJSON(e){const t=e.filter(e=>1===e['Error-Flag']),r={},n={};t.forEach(e=>{(e['Error-Reason']||'').split('; ').forEach(e=>{const t=e.split(':')[0].trim();t&&(r[t]=(r[t]||0)+1)}),(e['Error-Fields']||[]).forEach(e=>{n[e]||(n[e]=0),n[e]++})});const i=e=>e?e.includes('MISSING_DATA')?'critical':e.includes('INVALID')||e.includes('CONFLICT')?'warning':'info':'info';return{summary:{total_products:e.length,products_with_errors:t.length,error_rate:e.length>0?parseFloat((t.length/e.length*100).toFixed(2)):0,last_updated:(new Date).toISOString()},error_breakdown:r,errors_by_field:n,flagged_products:t.map(e=>({asin:e.asin,name:e.name,currency:e.currency,error_flag:e['Error-Flag'],error_reason:e['Error-Reason']||'',error_fields:e['Error-Fields']||[],price:e.price,original_price:e.originalPrice,discount_percentage:e.discountPercentage,affiliate_link:e.affiliate_link,main_image:e.main_image,category:e.category,brand:e.brand,severity:i(e['Error-Reason'])})).sort((e,t)=>({critical:0,warning:1,info:2}[e.severity]-{critical:0,warning:1,info:2}[t.severity]))}}
function parsePrice(e){if(!e||''===e||'Not Specified'===e||'0'===e)return null;const t=parseFloat(String(e).replace(/[^\d.]/g,''));return isNaN(t)?null:t}
function validateField(e,t,r,n={}){let i=r[e],o=0,a='',s=[];t.type&&'number'===t.type&&(i=parsePrice(i)),t.normalize&&(i=t.normalize(i,r));let c=null;if(t.computed&&(c=t.computed({...r,...n}),i||0===i||(i=c)),t.validate){const e=t.validate(i,{...r,...n},c);e.valid||(o=1,a=e.reason,s.push(e),void 0!==e.corrected&&(i=e.corrected))}if((null===i||void 0===i||''===i)&&t.fallback){const e=t.fallback({...r,...n});null!==e&&void 0!==e&&(i=e,t.errorMessage&&(o=1,a=t.errorMessage,s.push(e)))}return'number'===t.type&&null!==i&&(void 0!==t.min&&i<t.min&&(i=t.min,o=1,a=`VALUE_TOO_LOW: ${e}`,s.push(e)),void 0!==t.max&&i>t.max&&(i=t.max,o=1,a=`VALUE_TOO_HIGH: ${e}`,s.push(e))),{value:i,errorFlag:o,errorReason:a,errorFields:s}}
function validatePricing(e){const t={price:parsePrice(e.price),originalPrice:parsePrice(e.originalPrice),discountPercentage:parsePrice(e.discountPercentage),availability:e.availability};let r=[],n=[],i=[];for(const[o,a]of Object.entries(validationConfig.fields))if(['price','originalPrice','discountPercentage','availability'].includes(o)){const s=validateField(o,a,e,t);t[o]=s.value,s.errorFlag&&(r.push(o),n.push(s.errorReason),i.push(...s.errorFields))}return validationConfig.fields.availability.cascade&&Object.assign(t,validationConfig.fields.availability.cascade(t.availability,t)),t.price&&0!==t.price||t.originalPrice&&0!==t.originalPrice||(t.price=0,t.originalPrice=0,t.discountPercentage=0,t.availability='Currently Unavailable',r.push('price_data'),n.push('MISSING_DATA: Both price & originalPrice missing'),i.push('price','originalPrice')),{...t,errorFlag:r.length>0?1:0,errorReason:n.join('; '),errorFields:[...new Set(i)]}}
function detectCurrencyFromPrice(e){if(!e)return null;for(const[t,r]of Object.entries(CURRENCY_PATTERNS))if(e.includes(t))return r;return null}
function detectCurrencyFromField(e){if(!e||!e.trim())return null;const t=e.trim();if(CURRENCY_MAP[t.toUpperCase()])return t.toUpperCase();if(CURRENCY_PATTERNS[t])return CURRENCY_PATTERNS[t];for(const[e,r]of Object.entries(CURRENCY_PATTERNS))if(t.includes(e))return r;return null}
function extractMainCategory(e){if(!e)return'';const t=e.split('>').map(e=>e.trim()).filter(Boolean);if(1===t.length)return'general'!==t[0].toLowerCase()?t[0]:'';const r=t.filter(e=>!['general','all','products','shop','store'].includes(e.toLowerCase()));return r.length>0?r[0]:t[0]||''}
function generateAsin(e){return e.asin||`B0${Date.now().toString().slice(-8)}${Math.random().toString(36).substr(2,2).toUpperCase()}`}
function parseReferenceMedia(e,t){const r=[];if(!e||''===e.trim())return t?[t]:[];const n=e.trim();if(n.startsWith('['))try{const e=JSON.parse(n);Array.isArray(e)&&r.push(...e.map(e=>e.trim()).filter(Boolean))}catch(e){console.warn('‚ö†Ô∏è Invalid JSON in reference_media')}else{let e='|';n.includes('|')?e='|':n.includes(';')?e=';':n.includes(',')&&(e=','),r.push(...n.split(e).map(e=>e.trim()).filter(Boolean))}return t&&!r.includes(t)&&r.unshift(t),[...new Set(r)]}
function detectRegionalVariants(e){const t={};e.forEach(e=>{e.referenceMedia.forEach(r=>{t[r]||(t[r]=[]),t[r].push(e)})}),Object.values(t).forEach(e=>{e.length>1&&e.forEach(t=>{e.forEach(e=>{t.asin!==e.asin&&t.currency!==e.currency&&(t.regional_variants||(t.regional_variants={}),t.regional_variants[e.currency]=e.asin,t.regional_availability=1)})})})}
function extractCoreFields(e,t,r,n){const i=extractMainCategory(e.categoryHierarchy||''),o=e.Category?.trim()||'';let a='';a=i&&'general'!==i.toLowerCase()?i:o&&'general'!==o.toLowerCase()?o:i||o||'General';const s=getProductReleaseDate(e),{influencer:c,manualCollections:l,seasonOverride:u}=extractInfluencerAndCollections(e),d=detectSeasonFromText((e.productTitle||'')+' '+(e.Description||''),u);return{asin:generateAsin(e),name:e.productTitle||e.Title||'',description:e.Description||'',price:t.price||0,original_price:t.originalPrice||0,originalPrice:t.originalPrice||0,discount_percentage:t.discountPercentage||0,discountPercentage:t.discountPercentage||0,availability:t.availability||'In Stock','Error-Flag':t.errorFlag,'Error-Reason':t.errorReason||'','Error-Fields':t.errorFields||[],currency:r,symbol:'MISC'===r?'üéÅ':CURRENCY_MAP[r]?.symbol||r,brand:e.brand||'',category:a,subcategory:e.itemTypeName||'',main_image:e.MainImage||'',all_images:(()=>{if(!e.AllImages)return[];try{return'string'==typeof e.AllImages?JSON.parse(e.AllImages):e.AllImages}catch(t){return e.AllImages.split(',').map(e=>e.trim())}})(),customer_rating:e.customerRating||e.Rating||'',review_count:parseInt(e.reviewCount||e.ReviewCount)||0,source_link:e['Product Source Link']||'',referenceMedia:n,regional_availability:0,regional_variants:{},amazon_short:e['Amazon SiteStripe (Short)']||'',amazon_long:e['Amazon SiteStripe (Long)']||'',affiliate_link:e['Amazon SiteStripe (Short)']||'',release_date:s?s.toISOString():null,influencer:c,manual_collections:l,season:d,featured:!1,trending:!1}}
function deleteOldFiles(){if(!fs.existsSync(dataDir))return fs.mkdirSync(dataDir,{recursive:!0}),[];const e=fs.readdirSync(dataDir),t=[];return e.forEach(e=>{const r=path.join(dataDir,e);if('products.csv'!==e&&'last_updated.txt'!==e){let n=0;for(;n<3;){try{fs.unlinkSync(r),t.push(e);break}catch(e){n++,3===n&&console.error(`Failed to delete ${e} after 3 attempts`)}}}}),t}
function convertCsvToJson(){const e={},t={total:0,processed:0,errors:0,validationErrors:0,fieldConflicts:0,currenciesFound:new Set,categoriesFound:new Set,brandsFound:new Set,influencersFound:new Set,manualCollectionsFound:new Set,seasonsFound:new Set},r={};console.log('üîÑ Checking files before deletion...');const n=fs.existsSync(dataDir)?fs.readdirSync(dataDir):[];console.log('üîÑ Deleting old files...');const i=deleteOldFiles();console.log('‚úÖ Old files deletion complete.');let o=`VibeDrips Data Processing Summary\nGenerated: ${(new Date).toISOString()}\n\nüìä STATISTICS\n- Total Rows Processed: 0\n- Products Successfully Processed: 0\n- Errors Encountered: 0\n- Success Rate: 0.0%\n\nüí∞ CURRENCIES\n- Currencies Found: 0\n- Available: \n\nüì¶ CATEGORIES\n- Categories Found: 0\n- Top Categories: \n\nüè∑Ô∏è BRANDS\n- Brands Found: 0\n- Top Brands: \n\nüìÅ FILES BEFORE DELETION\n${n.map(e=>`- ${e}`).join('\n')||'- None'}\n\nüìÅ FILES DELETED\n${i.length>0?i.map(e=>`- ${e}`).join('\n'):'- None'}`;const a=fs.existsSync(dataDir)?fs.readdirSync(dataDir):[],s=a.filter(e=>!['last_updated.txt','products.csv'].includes(e));o+=`\n\nüìÅ FILES PRESENT AFTER DELETION\n${a.map(e=>`- ${e}`).join('\n')||'- None'}`,s.length>0&&(o+=`\n‚ö†Ô∏è Deletion failed for unexpected files:\n${s.map(e=>`- ${e}`).join('\n')}`),fs.writeFileSync(path.join(dataDir,'last_updated.txt'),o),console.log('üîÑ Processing CSV from input...'),process.stdin.pipe(csv()).on('data',n=>{t.total++;try{console.log(`\n--- Row ${t.total} ---`);let i=null;n.Currency&&n.Currency.trim()&&(i=detectCurrencyFromField(n.Currency)),i||!n.price||(i=detectCurrencyFromPrice(n.price)),i||(i='MISC'),console.log(`‚úÖ Currency: ${i}`),t.currenciesFound.add(i),n.categoryHierarchy&&t.categoriesFound.add(extractMainCategory(n.categoryHierarchy)),n.brand&&t.brandsFound.add(n.brand),n.Influencer?.trim()&&t.influencersFound.add(n.Influencer.trim()),n.ManualCollections?.trim()&&n.ManualCollections.split(/[|,]/).forEach(e=>{const r=e.trim();r&&t.manualCollectionsFound.add(r)});const o=validatePricing({price:n.price,originalPrice:n.originalPrice,discountPercentage:n.discountPercentage,availability:n.availability});if(1===o.errorFlag&&(t.validationErrors++,console.log(`‚ö†Ô∏è Validation: ${o.errorReason}`),o.errorReason.split('; ').forEach(e=>{const t=e.split(':')[0];r[t]=(r[t]||0)+1})),a=parseReferenceMedia(n.reference_media||n['Reference Media for similar products'],n['Product Source Link']),s=extractCoreFields(n,o,i,a),s.season&&t.seasonsFound.add(s.season),c=structureProductData(n,s),c['Error-Fields']&&c['Error-Fields'].length>0&&t.fieldConflicts++,c._dropSignalsPreCompute={sourceLink:n['Product Source Link']||'',influencer:n.Influencer||''},e[i]||(e[i]=[]),e[i].push(c),t.processed++}catch(e){t.errors++,console.error(`Error processing row ${t.total}:`,e.message)}var a,s,c}).on('end',()=>{console.log('üìä Processing Complete! Generating files...');const n=Object.values(e).flat();console.log(`üîç Detecting regional variants across ${n.length} products...`),detectRegionalVariants(n);const i=n.filter(e=>1===e.regional_availability).length;console.log(`‚úÖ Found ${i} products with regional variants`),console.log('üé¨ Computing drop signals...');const o={'creator-picks':0,'global-drops':0,'viral-reels':0,'new-releases':0};n.forEach(e=>{const t=computeDropSignals(e._dropSignalsPreCompute||{},e.referenceMedia,e.regional_variants,e.release_date);e.drop_signals=t,t.drop_categories.forEach(e=>{o[e]=(o[e]||0)+1}),delete e._dropSignalsPreCompute}),console.log('‚úÖ Drop signals computed:'),Object.entries(o).forEach(([e,t])=>{console.log(`  ${DROPS_CONFIG.CATEGORIES[e].emoji} ${DROPS_CONFIG.CATEGORIES[e].label}: ${t} products`)}),Object.keys(e).forEach(t=>{e[t].sort((e,t)=>{const r=e.release_date?new Date(e.release_date):new Date(0),n=t.release_date?new Date(t.release_date):new Date(0);return n-r})});const a={available_currencies:[],last_updated:(new Date).toISOString(),total_products:t.processed,default_currency:'INR'};Object.keys(e).forEach(t=>{const r=e[t],n=`products-${t}.json`,i=path.join(dataDir,n);fs.writeFileSync(i,JSON.stringify(r,null,2));const o={code:t,name:'MISC'===t?'Mixed Currency Products':CURRENCY_MAP[t]?.name||t,symbol:'MISC'===t?'üéÅ':CURRENCY_MAP[t]?.symbol||t,countries:'MISC'===t?['Global']:CURRENCY_MAP[t]?.countries||[],product_count:r.length,filename:n,categories:[...new Set(r.map(e=>e.category))].filter(Boolean),brands:[...new Set(r.map(e=>e.brand))].filter(Boolean),price_range:r.length>0?{min:Math.min(...r.map(e=>e.price).filter(e=>e>0)),max:Math.max(...r.map(e=>e.price))}:{min:0,max:0}};a.available_currencies.push(o),console.log(`üí∞ ${t}: ${r.length} products ‚Üí ${n}`)}),a.available_currencies.sort((e,t)=>t.product_count-e.product_count),fs.writeFileSync(path.join(dataDir,'currencies.json'),JSON.stringify(a,null,2)),console.log('\nüé¨ Generating drops.json...');const s=generateDropsJSON(n);fs.writeFileSync(path.join(dataDir,'drops.json'),JSON.stringify(s,null,2)),console.log('‚úÖ Drops manifest created: drops.json'),console.log('\nüë§ Generating influencers.json...');const c=generateInfluencersJSON(n);fs.writeFileSync(path.join(dataDir,'influencers.json'),JSON.stringify(c,null,2)),console.log(`‚úÖ Influencers manifest created: influencers.json (${Object.keys(c).length} influencers)`),console.log('\nüíé Generating collections.json...');const l=generateCollectionsJSON(n);fs.writeFileSync(path.join(dataDir,'collections.json'),JSON.stringify(l,null,2)),console.log(`‚úÖ Collections manifest created: collections.json (${Object.keys(l).length} collections)`),console.log('\n‚ö†Ô∏è  Generating errors.json...');const u=generateErrorsJSON(n);fs.writeFileSync(path.join(dataDir,'errors.json'),JSON.stringify(u,null,2)),console.log(`‚úÖ Errors manifest created: errors.json (${u.flagged_products.length} flagged products)`);const d=fs.existsSync(dataDir)?fs.readdirSync(dataDir):[],p=new Set(['last_updated.txt','products.csv',...Object.keys(e).map(e=>`products-${e}.json`),'currencies.json','drops.json','influencers.json','collections.json','errors.json']),f=d.filter(e=>!p.has(e)),g=`VibeDrips Data Processing Summary\nGenerated: ${(new Date).toISOString()}\n\nüìä STATISTICS\n- Total Rows Processed: ${t.total}\n- Products Successfully Processed: ${t.processed}\n- Errors Encountered: ${t.errors}\n- Success Rate: ${(t.processed/t.total*100).toFixed(1)}%\n\n‚ö†Ô∏è VALIDATION\n- Records Flagged: ${t.validationErrors}\n- Field Conflicts: ${t.fieldConflicts}\n${Object.entries(r).length>0?'- Error Breakdown:\n'+Object.entries(r).sort(([,e],[,t])=>t-e).map(([e,t])=>`  ‚Ä¢ ${e}: ${t}`).join('\n'):''}\n\nüí∞ CURRENCIES\n- Currencies Found: ${t.currenciesFound.size}\n- Available: ${Array.from(t.currenciesFound).join(', ')}\n\nüì¶ CATEGORIES\n- Categories Found: ${t.categoriesFound.size}\n- Top Categories: ${Array.from(t.categoriesFound).slice(0,5).join(', ')||'None'}\n\nüè∑Ô∏è BRANDS\n- Brands Found: ${t.brandsFound.size}\n- Top Brands: ${Array.from(t.brandsFound).slice(0,5).join(', ')||'None'}\n\nüë§ INFLUENCERS\n- Products with influencers: ${n.filter(e=>e.influencer).length}\n- Unique influencers: ${Object.keys(c).length}\n- List: ${Object.keys(c).join(', ')||'None'}\n\nüíé COLLECTIONS\n- Products in collections: ${n.filter(e=>e.manual_collections&&e.manual_collections.length>0).length}\n- Unique collections: ${Object.keys(l).length}\n- List: ${Object.keys(l).join(', ')||'None'}\n\nüåø SEASONS\n- Seasons Detected: ${t.seasonsFound.size}\n- Active: ${Array.from(t.seasonsFound).join(', ')||'None'}\n\n‚ö†Ô∏è ERRORS & VALIDATION\n- Products with errors: ${u.flagged_products.length}\n- Error rate: ${u.summary.error_rate}%\n- Critical errors: ${u.flagged_products.filter(e=>'critical'===e.severity).length}\n- Warnings: ${u.flagged_products.filter(e=>'warning'===e.severity).length}\n- Top error types: ${Object.entries(u.error_breakdown).sort(([,e],[,t])=>t-e).slice(0,3).map(([e,t])=>`${e} (${t})`).join(', ')||'None'}\n\nüé¨ DROPS\n${Object.entries(o).map(([e,t])=>`- ${DROPS_CONFIG.CATEGORIES[e].emoji} ${DROPS_CONFIG.CATEGORIES[e].label}: ${t} products`).join('\n')}\n\nüìÅ FILES BEFORE DELETION\n${filesBeforeDeletion.map(e=>`- ${e}`).join('\n')||'- None'}\n\nüìÅ FILES DELETED\n${deletedFiles.length>0?deletedFiles.map(e=>`- ${e}`).join('\n'):'- None'}\n\nüìÅ FILES GENERATED\n${Object.keys(e).map(t=>`- products-${t}.json (${e[t].length} products)`).join('\n')}\n- currencies.json (manifest)\n- drops.json (drops manifest)\n- influencers.json (${Object.keys(c).length} influencers)\n- collections.json (${Object.keys(l).length} collections)\n- errors.json (${u.flagged_products.length} flagged products)\n\nüìÅ FINAL FILES PRESENT\n${d.map(e=>`- ${e}`).join('\n')||'- None'}\n${f.length>0?`\n‚ö†Ô∏è Remnant files detected:\n${f.map(e=>`- ${e}`).join('\n')}`:''}`;fs.writeFileSync(path.join(dataDir,'last_updated.txt'),g),console.log('\n‚úÖ SUCCESS! Multi-currency data processing complete.'),console.log(`üìÅ Generated ${Object.keys(e).length} currency files`),console.log(`üìä Processed ${t.processed} products from ${t.total} rows`),console.log(`üí∞ Currencies: ${Array.from(t.currenciesFound).join(', ')}`),console.log(`üë§ Influencers: ${Object.keys(c).length}`),console.log(`üíé Collections: ${Object.keys(l).length}`),console.log(`üåø Seasons: ${Array.from(t.seasonsFound).join(', ')}`),console.log(`‚ö†Ô∏è  Errors: ${u.flagged_products.length} flagged (${u.summary.error_rate}% error rate)`),t.validationErrors>0&&console.log(`‚ö†Ô∏è ${t.validationErrors} products flagged for review (Error-Flag=1)`),t.fieldConflicts>0&&console.log(`‚ö†Ô∏è ${t.fieldConflicts} products with field conflicts (check Error-Fields)`),t.errors>0&&console.log(`‚ö†Ô∏è ${t.errors} rows had processing errors`)}).on('error',e=>{console.error('‚ùå Error processing CSV:',e),process.exit(1)})}
console.log('üöÄ VibeDrips Multi-Currency Product Processor v7.0');
console.log('===================================================');
console.log('‚ú® Lean Manifests + Error Tracking + Drop Products');
console.log('');
convertCsvToJson();
